# Codebase Structure

**Analysis Date:** 2026-02-03

## Directory Layout

```
ai-weekly-changelog-action/
â”œâ”€â”€ action.yml                          # GitHub Action manifest (composite action definition)
â”œâ”€â”€ src/
â”‚   â””â”€â”€ generate_changelog.py           # Core Python logic (AI summarization, changelog management)
â”œâ”€â”€ .github/workflows/
â”‚   â”œâ”€â”€ example-simple.yml              # Minimal usage example (scheduled only)
â”‚   â”œâ”€â”€ example-full.yml                # Full example with all parameters exposed
â”‚   â””â”€â”€ auto-latest.yml                 # Internal: auto-update action to latest tag
â”œâ”€â”€ .planning/codebase/                 # GSD planning documents
â”œâ”€â”€ README.md                           # User-facing documentation
â”œâ”€â”€ CONTRIBUTING.md                     # Contributor guidelines
â”œâ”€â”€ CLAUDE.md                           # Claude Code instructions
â”œâ”€â”€ SECURITY.md                         # Security policy
â”œâ”€â”€ LICENSE                             # License file
â”œâ”€â”€ requirements.txt                    # Python dependencies
â””â”€â”€ .claude/settings.local.json          # Local Claude Code settings
```

## Directory Purposes

**action.yml:**
- Purpose: GitHub Action definition (composite action, not Docker)
- Contains: 7 orchestration steps, input definitions, output handling
- Key files: None (single file definition)

**src/:**
- Purpose: Core business logic (Python implementation)
- Contains: AI integration, changelog generation, error handling
- Key files: `generate_changelog.py` (723 lines)

**.github/workflows/:**
- Purpose: Example workflow files for users (not used by the action itself)
- Contains: Reusable workflow templates for different use cases
- Key files:
  - `example-simple.yml`: Minimal setup (scheduled runs)
  - `example-full.yml`: Full parameters with manual controls
  - `auto-latest.yml`: Internal workflow for maintaining action version tag

**.planning/codebase/:**
- Purpose: GSD (Guided Solution Development) analysis documents
- Contains: Architecture, structure, conventions, testing, concerns
- Key files: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md

## Key File Locations

**Entry Points:**

**`action.yml`**
- Purpose: GitHub Action definition entry point
- Responsibility: Define inputs, coordinate 7 execution steps, declare outputs
- Used by: GitHub Actions runtime when action is invoked from workflows

**`src/generate_changelog.py`**
- Purpose: Main Python execution entry point
- Responsibility: Parse environment, validate API key, generate summaries, manage changelog
- Used by: action.yml step "Generate changelog with OpenRouter"
- Initialization: Module-level code (lines 81-116) runs immediately on import

**Configuration:**

**`action.yml` (lines 10-41)**
- Input definitions: openrouter_api_key (required), github_token (deprecated), days_back, model, language, force, extended, dry_run
- Input validation: days_back range check (1-365) in "Validate inputs" step
- Dynamic configuration: Fetch-depth scales with days_back (lines 59)

**`requirements.txt`**
- Python dependencies: openai>=1.14,<2, requests
- No transitive deps listed (openai brings in urllib3, httpx, etc.)
- Installed dynamically in "Install Python dependencies" step

**Core Logic:**

**`src/generate_changelog.py` (lines 1-723)**
- API Integration: OpenRouter via OpenAI Python client (lines 99-103)
- Retry Logic: @retry_api_call decorator (lines 10-79)
- Language Config: Maps for 5 languages (lines 118-209)
- Chunking System: Intelligent split for commits > 5 (lines 380-392, 543-579)
- Changelog Management: File I/O, duplicate detection, week-based sections (lines 612-722)

**Cache & State:**

**`/tmp/changelog_cache/`** (created at runtime)
- Purpose: Store commit data and metadata across action invocations
- Structure: `{cache_key}_commits.txt`, `{cache_key}_extended.txt`, `{cache_key}_files.txt`, `{cache_key}.meta`
- Cache key: `{HEAD:0-8}_{days_back}_{extended_mode}`
- Cleanup: Automatic removal of files older than 5 most recent sets (action.yml line 185)

**`CHANGELOG.md`** (created/updated during execution)
- Purpose: Persistent changelog output
- Generated by: src/generate_changelog.py (lines 704-705)
- Structure: Header + auto_updated note + week entries (newest first) + dividers

## Naming Conventions

**Files:**

- **Action definition**: `action.yml` (GitHub convention)
- **Python modules**: `snake_case.py` (e.g., `generate_changelog.py`)
- **Workflow files**: `kebab-case.yml` (e.g., `example-simple.yml`)
- **Documentation**: `UPPERCASE.md` (e.g., `README.md`, `CHANGELOG.md`)
- **Configuration**: Specific names (e.g., `requirements.txt`, `.claude/settings.local.json`)

**Directories:**

- **Source**: `src/` (all Python code)
- **Workflows**: `.github/workflows/` (GitHub convention)
- **Planning**: `.planning/codebase/` (GSD convention)
- **Config**: `.claude/` (Claude Code settings)

**Functions (Python):**

- **Decorators**: `retry_api_call` (verb_phrase, lowercase with underscores)
- **Main functions**: `generate_summary`, `generate_chunked_summary`, `merge_chunk_summaries`, `cleanup_temp_files` (verb_object pattern)
- **Helpers**: `process_commits_in_chunks` (verb_object pattern)

**Variables (Python):**

- **Constants**: `COMMITS_PER_CHUNK` (UPPERCASE_WITH_UNDERSCORES)
- **Configuration maps**: `language_configs`, `date_formats`, `language_config` (snake_case)
- **Status flags**: `has_commits`, `use_chunking`, `force_update`, `dry_run`, `extended_analysis` (snake_case with boolean meaning)
- **Data holders**: `commits_formatted`, `commit_links`, `chunk_summaries` (snake_case, plural for collections)
- **Temporary files**: `commits.txt`, `commits_extended.txt`, `files_changed.txt` (kebab-case with extension)

**Environment Variables (Bash/Action):**

- **API credentials**: OPENROUTER_API_KEY (UPPERCASE_WITH_UNDERSCORES)
- **Configuration**: MODEL, OUTPUT_LANGUAGE, FORCE_UPDATE, DRY_RUN, EXTENDED_ANALYSIS (UPPERCASE_WITH_UNDERSCORES)
- **Paths**: GITHUB_REPOSITORY, GITHUB_OUTPUT, GITHUB_STEP_SUMMARY (GitHub convention)
- **Temporary**: SINCE_DATE, DAYS_BACK, CACHE_KEY, GIT_FILTERS (temporary bash variables)

## Where to Add New Code

**New Feature (e.g., add new summarization step):**
- Primary code: `src/generate_changelog.py` (add function for new step, call from main flow around line 582-594)
- Configuration: `action.yml` (add new step if orchestration needed, or new input parameter)
- Input declaration: `action.yml` lines 10-41 (if new user-facing parameter)

**New Language Support:**
- Configuration: `src/generate_changelog.py` lines 118-209
- Add new entry in `language_configs` dictionary with key = language name
- Add to workflow examples: `.github/workflows/example-full.yml` (lines 174-179, update options)

**New Analysis Mode (e.g., security-focused summary):**
- Prompt template: `src/generate_changelog.py` (create new `*_prompt_template` around line 404)
- Generation function: `src/generate_changelog.py` (call `generate_chunked_summary()` with new prompt)
- Changelog entry: `src/generate_changelog.py` lines 670-686 (add new section in changelog_entry)

**New Metadata or Statistics:**
- Git collection: `action.yml` lines 107-163 (add git log operation in "Collect commits" step)
- Cache handling: `action.yml` lines 81-104 (add new file to cache if/meta logic)
- Python parsing: `src/generate_changelog.py` lines 225-263 (add file read and parsing)
- Output: `src/generate_changelog.py` lines 150-153 (add to GITHUB_OUTPUT if needed)

**New Error Handler or Validation:**
- Input validation: `action.yml` lines 46-54 (add bash validation in "Validate inputs" step)
- API error handling: `src/generate_changelog.py` lines 20-70 (add new error_str check in @retry_api_call)
- File I/O error handling: `src/generate_changelog.py` lines 710-717 (add to except block)

**Tests (if testing framework added):**
- Unit tests: `tests/unit/` (parallel structure to `src/`)
- Integration tests: `tests/integration/` (test full workflows)
- Fixtures: `tests/fixtures/` (mock commits, API responses)

## Special Directories

**`.planning/codebase/`**
- Purpose: GSD (Guided Solution Development) analysis output
- Generated: Yes (created by gsd:map-codebase command)
- Committed: Yes (checked into repository)
- Contents: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md

**`.github/workflows/`**
- Purpose: Example workflows for users (documentation, not used by action itself)
- Generated: No (manually maintained)
- Committed: Yes
- Note: Actual user workflows live in consuming repositories, not here

**`.claude/`**
- Purpose: Local Claude Code editor settings
- Generated: Yes (by Claude Code editor if needed)
- Committed: Yes (but optional)
- Contents: `settings.local.json` (local overrides)

**`/tmp/changelog_cache/`** (runtime, not committed)
- Purpose: Temporary cache for git operations between runs
- Generated: Yes (automatically by action at runtime)
- Committed: No (outside repository)
- Cleanup: Automatic (keeps last 5 cache sets)

## Guidance for Adding New Code

**For new features that modify the action interface:**
1. Update `action.yml` inputs section (lines 10-41) with new parameter
2. Add validation in "Validate inputs" step (lines 46-54) if needed
3. Pass parameter as environment variable to Python script (line 238, add to env:)
4. Handle in `src/generate_changelog.py` via `os.getenv()`

**For new summarization steps:**
1. Create prompt template (following tech_prompt_template or business_prompt_template pattern, lines 404-500)
2. Call `generate_chunked_summary()` with prompt (line 582-594)
3. Add result to changelog_entry (lines 670-686)
4. Update language_configs if new section labels needed (lines 118-209)

**For new analysis data (extended mode):**
1. Add git log operation in action.yml "Collect commits" step (lines 110-163)
2. Cache the data in cache file handling (lines 90-104)
3. Parse in src/generate_changelog.py (lines 225-263)
4. Include in prompts as context (lines 397-402)

**For error handling improvements:**
1. Add error condition check in @retry_api_call decorator (lines 20-70)
2. Provide actionable guidance message (matching existing patterns with ðŸ’¡ suggestions)
3. Preserve exit code semantics (1 = error, 0 = success)

**For language support additions:**
1. Add new language entry to `language_configs` dict (lines 118-209)
2. Update workflow examples (`.github/workflows/example-full.yml`, adjust language choices)
3. Test with different output_language values to verify all labels translate
