---
phase: 01-code-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/generate_changelog.py
autonomous: true

must_haves:
  truths:
    - "API key never appears in error messages, even when the key causes the error"
    - "Error messages show '[REDACTED]' or similar placeholder instead of actual key"
    - "All exception paths that could print the key now use redaction"
  artifacts:
    - path: "src/generate_changelog.py"
      provides: "API key redaction utility and secured error handling"
      contains: "def redact_api_key"
      contains_also: "REDACTED"
  key_links:
    - from: "retry_api_call decorator"
      to: "redact_api_key function"
      via: "str(e) replacement"
      pattern: "redact_api_key.*str\\(e\\)"
    - from: "error print statements"
      to: "redacted output"
      via: "redact function call"
      pattern: "print.*redact"
---

<objective>
Add API key redaction to all error message paths to prevent accidental key exposure in logs.

Purpose: Security hardening to ensure the OpenRouter API key never leaks via exception messages or error logging, even if the key itself causes parsing errors or appears in error strings.

Output: Updated `src/generate_changelog.py` with a redaction utility function and all error paths secured.
</objective>

<execution_context>
@/Users/robertfridzema/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertfridzema/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@src/generate_changelog.py
@.planning/phases/01-code-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key redaction utility</name>
  <files>src/generate_changelog.py</files>
  <action>
Add a redaction utility function near the top of the file, AFTER the imports but BEFORE the retry_api_call decorator (around line 9).

```python
def redact_api_key(text: str) -> str:
    """Redact API key from error messages to prevent accidental exposure."""
    api_key = os.getenv("OPENROUTER_API_KEY", "")
    if api_key and len(api_key) > 8:
        # Redact the full key, showing only first 4 chars for debugging
        redacted = api_key[:4] + "..." + "[REDACTED]"
        text = text.replace(api_key, redacted)
    # Also catch common API key patterns that might appear
    import re
    # Redact any sk-or-* pattern (OpenRouter keys)
    text = re.sub(r'sk-or-[a-zA-Z0-9_-]+', 'sk-or-...[REDACTED]', text)
    return text
```

Why this approach:
- Replaces the actual key value if it appears in any error string
- Also catches partial matches via regex pattern
- Shows first 4 chars for debugging ("I can see it starts with sk-or-v1...")
- Works even if key appears multiple times or in unexpected contexts
  </action>
  <verify>
Test the redaction function:
```bash
cd /Users/robertfridzema/workspace/ai-weekly-changelog-action
python3 -c "
import os
os.environ['OPENROUTER_API_KEY'] = 'sk-or-v1-abc123def456'
# Import just the function
exec('''
def redact_api_key(text):
    api_key = os.getenv(\"OPENROUTER_API_KEY\", \"\")
    if api_key and len(api_key) > 8:
        redacted = api_key[:4] + \"...\" + \"[REDACTED]\"
        text = text.replace(api_key, redacted)
    import re
    text = re.sub(r\"sk-or-[a-zA-Z0-9_-]+\", \"sk-or-...[REDACTED]\", text)
    return text
''')
test_msg = 'Error with key sk-or-v1-abc123def456 failed'
result = redact_api_key(test_msg)
assert '[REDACTED]' in result, f'Redaction failed: {result}'
assert 'abc123def456' not in result, f'Key not fully redacted: {result}'
print('Redaction test passed')
"
```
  </verify>
  <done>
- `redact_api_key` function exists and is callable
- Function redacts full API key value from any string
- Function catches sk-or-* patterns via regex as backup
- Shows only first 4 characters for debugging context
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply redaction to all error paths</name>
  <files>src/generate_changelog.py</files>
  <action>
Update all error handling code in the retry_api_call decorator (lines ~10-79) to use redaction.

**Changes to make in the retry_api_call decorator:**

1. Line ~25 (rate limit error):
   - Change: `raise Exception(f"Rate limit exceeded: {str(e)}")`
   - To: `raise Exception(f"Rate limit exceeded: {redact_api_key(str(e))}")`

2. Line ~37-40 (auth error):
   - Change: `print(f"Authentication failed: {str(e)}")`
   - To: `print(f"Authentication failed: {redact_api_key(str(e))}")`
   - Also change the raise on line ~40

3. Line ~44-48 (model error):
   - Change: `print(f"Model error: {str(e)}")`
   - To: `print(f"Model error: {redact_api_key(str(e))}")`
   - Also change the raise

4. Line ~53-55 (network error):
   - Change all `{str(e)}` occurrences to `{redact_api_key(str(e))}`

5. Line ~65 (final attempt):
   - Change: `print(f"Final attempt failed: {str(e)}")`
   - To: `print(f"Final attempt failed: {redact_api_key(str(e))}")`

6. Line ~74 (generic retry message):
   - Change: `print(f"API call failed (attempt ...): {str(e)}")`
   - To: `print(f"API call failed (attempt ...): {redact_api_key(str(e))}")`

Also check and update:
- Line ~586, ~593 (fallback summary error messages) - may print exceptions
- Line ~711 (changelog write error) - may print exceptions

Pattern to follow: Any `print(...)` or `raise Exception(...)` that includes `{str(e)}` or `{e}` should use `redact_api_key(str(e))` instead.
  </action>
  <verify>
1. Count redact_api_key usage:
```bash
grep -c "redact_api_key" src/generate_changelog.py
```
Should be >= 8 (function definition + all error paths)

2. Check no raw str(e) in error prints:
```bash
grep -n "print.*str(e)" src/generate_changelog.py | grep -v "redact_api_key"
```
Should return empty (all exception prints use redaction)

3. Verify syntax:
```bash
python3 -m py_compile src/generate_changelog.py
```
Should exit 0
  </verify>
  <done>
- All print statements in retry_api_call use redact_api_key
- All raise Exception statements use redact_api_key for error messages
- Fallback summary error messages use redact_api_key
- Changelog write error uses redact_api_key
- No path can leak the full API key in output
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Redaction function exists:**
   ```bash
   grep -n "def redact_api_key" src/generate_changelog.py
   ```
   Should show function definition

2. **All error paths use redaction:**
   ```bash
   grep -E "print.*{str\(e\)}|raise.*{str\(e\)}" src/generate_changelog.py
   ```
   Should return empty (no unprotected exception string interpolation)

3. **Redaction is applied consistently:**
   ```bash
   grep -c "redact_api_key(str(e))" src/generate_changelog.py
   ```
   Should show multiple occurrences (6+)

4. **Script compiles:**
   ```bash
   python3 -m py_compile src/generate_changelog.py && echo "OK"
   ```
   Should output "OK"

5. **Integration test (simulated):**
   ```bash
   python3 -c "
   import os
   os.environ['OPENROUTER_API_KEY'] = 'sk-or-test-secret123'
   # Test that even if we construct an error message with the key, it gets redacted
   exec(open('src/generate_changelog.py').read().split('# Read commits')[0])
   # The redact function should now be defined
   test = redact_api_key('Error: sk-or-test-secret123 is invalid')
   assert 'secret123' not in test
   print('Integration test passed')
   "
   ```
</verification>

<success_criteria>
- FIX-04: API key never appears in any error output path
- New `redact_api_key` function handles both exact matches and pattern matches
- All 8+ error paths in retry_api_call use redaction
- Fallback and changelog error messages also use redaction
- Script syntax valid and functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-foundation/01-02-SUMMARY.md`
</output>
