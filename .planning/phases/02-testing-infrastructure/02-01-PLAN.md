---
phase: 02-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/conftest.py
  - requirements-dev.txt
autonomous: true

must_haves:
  truths:
    - "pytest command runs without import errors"
    - "Test environment has OPENROUTER_API_KEY set before module import"
    - "Coverage is configured with 80% threshold"
  artifacts:
    - path: "pyproject.toml"
      provides: "pytest and coverage configuration"
      contains: "[tool.pytest.ini_options]"
    - path: "tests/conftest.py"
      provides: "Shared fixtures and environment setup"
      contains: "setup_test_environment"
    - path: "requirements-dev.txt"
      provides: "Test dependencies"
      contains: "pytest"
  key_links:
    - from: "tests/conftest.py"
      to: "src/generate_changelog.py"
      via: "Environment setup before import"
      pattern: "OPENROUTER_API_KEY"
---

<objective>
Set up pytest infrastructure with shared fixtures and configuration

Purpose: Create the foundation for all test files - pytest configuration, coverage settings, and shared fixtures that handle the module's import-time side effects.
Output: Working pytest setup where `pytest --collect-only` succeeds without errors
</objective>

<execution_context>
@/Users/robertfridzema/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertfridzema/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-testing-infrastructure/02-CONTEXT.md
@.planning/phases/02-testing-infrastructure/02-RESEARCH.md
@src/generate_changelog.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pytest configuration and dev dependencies</name>
  <files>pyproject.toml, requirements-dev.txt</files>
  <action>
1. Create `requirements-dev.txt` with test dependencies:
   ```
   pytest>=8.0
   pytest-cov>=4.0
   pytest-mock>=3.0
   ```

2. Create or update `pyproject.toml` with pytest and coverage configuration:
   ```toml
   [tool.pytest.ini_options]
   testpaths = ["tests"]
   python_files = "test_*.py"
   python_functions = "test_*"
   addopts = "-v --tb=short"

   [tool.coverage.run]
   source = ["src"]
   branch = true

   [tool.coverage.report]
   fail_under = 80
   show_missing = true
   exclude_lines = [
       "pragma: no cover",
       "if __name__ == .__main__.:",
   ]
   ```

NOTE: Do NOT add [project] metadata section - this is a GitHub Action, not a pip-installable package. Only add tool configuration sections.
  </action>
  <verify>
```bash
pip install -r requirements-dev.txt
python -c "import pytest; print(pytest.__version__)"
```
  </verify>
  <done>
- pyproject.toml contains [tool.pytest.ini_options] and [tool.coverage.*] sections
- requirements-dev.txt contains pytest, pytest-cov, pytest-mock
- Dependencies install successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create conftest.py with environment setup and shared fixtures</name>
  <files>tests/conftest.py</files>
  <action>
Create `tests/conftest.py` with:

1. **Session-scoped autouse fixture** that sets required environment variables BEFORE any module imports:
   - OPENROUTER_API_KEY = "sk-or-test-key-abcdef123456"
   - GITHUB_REPOSITORY = "test-org/test-repo"
   - MODEL = "openai/gpt-5-mini"
   - OUTPUT_LANGUAGE = "English"
   - FORCE_UPDATE = "false"
   - EXTENDED_ANALYSIS = "false"
   - DRY_RUN = "false"
   - DAYS_BACK = "7"

2. **sample_commits fixture** returning list of formatted commit strings:
   ```python
   @pytest.fixture
   def sample_commits():
       return [
           "abc123|feat: Add new feature|Author1|2024-01-01|abc",
           "def456|fix: Fix critical bug|Author2|2024-01-02|def",
           "ghi789|docs: Update README|Author3|2024-01-03|ghi",
       ]
   ```

3. **sample_commits_raw fixture** returning raw commits.txt content (newline-separated)

4. **mock_openai_response fixture** returning a Mock object mimicking OpenAI API response structure:
   ```python
   response.choices[0].message.content = "### Technical Summary\nTest content"
   ```

5. **clean_files fixture** using tmp_path and monkeypatch.chdir for isolated file testing

IMPORTANT: The session-scoped fixture MUST be autouse=True and scope="session" to ensure environment is set before any test file imports the module.
  </action>
  <verify>
```bash
mkdir -p tests
pytest --collect-only 2>&1 | head -20
```
Should show "collected 0 items" (no tests yet) without import errors.
  </verify>
  <done>
- tests/conftest.py exists with setup_test_environment fixture
- pytest --collect-only runs without errors
- All 5 fixtures defined: setup_test_environment, sample_commits, sample_commits_raw, mock_openai_response, clean_files
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tests/__init__.py and verify full setup</name>
  <files>tests/__init__.py</files>
  <action>
1. Create empty `tests/__init__.py` to make tests a proper Python package

2. Create a minimal smoke test file `tests/test_smoke.py` to verify the setup works:
   ```python
   """Smoke test to verify pytest setup and module import."""

   def test_pytest_runs():
       """Verify pytest is working."""
       assert True

   def test_module_imports(setup_test_environment):
       """Verify generate_changelog can be imported after env setup."""
       import src.generate_changelog
       assert hasattr(src.generate_changelog, 'retry_api_call')
       assert hasattr(src.generate_changelog, 'redact_api_key')
   ```

3. Run pytest to verify everything works together

NOTE: The smoke test explicitly depends on setup_test_environment fixture to ensure import happens AFTER env vars are set.
  </action>
  <verify>
```bash
pytest tests/test_smoke.py -v
```
Both tests should pass.
  </verify>
  <done>
- tests/__init__.py exists
- tests/test_smoke.py passes both tests
- Module imports successfully in test environment
- pytest infrastructure ready for additional test files
  </done>
</task>

</tasks>

<verification>
```bash
# Full verification
pip install -r requirements-dev.txt
pytest tests/test_smoke.py -v
pytest --collect-only
```

Expected output:
- Dependencies install without errors
- 2 smoke tests pass
- No import errors during collection
</verification>

<success_criteria>
1. `pytest --collect-only` runs without import errors
2. `tests/conftest.py` contains session-scoped autouse fixture setting OPENROUTER_API_KEY
3. `pyproject.toml` contains pytest config with testpaths = ["tests"]
4. `pyproject.toml` contains coverage config with fail_under = 80
5. Smoke tests pass, confirming module can be imported in test context
</success_criteria>

<output>
After completion, create `.planning/phases/02-testing-infrastructure/02-01-SUMMARY.md`
</output>
